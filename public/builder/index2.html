<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>builder</title>
  <link rel="stylesheet" href="http://lib.sinaapp.com/js/jquery-ui/1.10.2/themes/smoothness/jquery-ui.min.css">
  <style>
  html, body {
    height: 100%;
    padding: 0;
    margin: 0;
  }
  
  body {
    background-color: #ddd;
  }
  
  #paper {
    position: relative;
    width: 400px;
    height: 600px;

    background-color: white;
    margin-top: 30px;
    margin-left: auto;
    margin-right: auto;
    
  }
  
  .blocks {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
  }
  
  .select-box {
    position: absolute;
    outline: 4px solid rgba(66, 194, 217, .5);
/*    box-shadow: 
      -4px 0 0 0 rgba(66, 194, 217, .5), 
      4px 0 0 0 rgba(66, 194, 217, .5),
      0 -4px 0 0 rgba(66, 194, 217, .5), 
      0 4px 0 0 rgba(66, 194, 217, .5);*/
    width: 100%;
    display:none;
  }
  
  .select-box:hover {
    cursor: move;
  }
  
  .block {
    position: relative;
  }
  
  .block:hover {
    box-shadow: 0 0 8px 0 rgba(66,194,217,1);
  }
  
  
  .block, .block .content, .select-box, .dropline {
    /*outline: 1px solid red;*/
    box-sizing: border-box;
  }
  
  .block .content {
    width: 100%;
    height: 100%;
  }
  
  .block.selected {
    box-shadow: -4px 0 8px 0 rgba(66,194,217,1);
  }
  
  .dropline {
    position: absolute;
    height: 50px;
    width: 100%;
    bottom: 0px;
    /*background-color: green;*/
  }
  
  .dropline.highlight {
     border-bottom: 1px dashed red;
  }
  
  .dropline.hover {
    /*background-color: yellow;*/
    border-bottom: 2px solid blue;
  }
  
  .titlebar {
    height: 50px;
    background-color: pink;
/*    border-bottom: 1px dashed #999;*/
  }
  
  .titlebar .content {
    text-align: center; 
  }
  
  .title {
    line-height: 50px;
    font-size: 1.5em;
  }
  
  .paragraph {
    
  }
  
  .paragraph .content {
    padding: 6px 15px 6px 15px;
  }
  
  .paragraph .content p {
    margin: 0;
    line-height: 1.5em;
  }
  </style>
  
  <script src="http://lib.sinaapp.com/js/jquery/1.9.1/jquery-1.9.1.min.js"></script>
  <script src="http://lib.sinaapp.com/js/jquery-ui/1.10.2/jquery-ui.min.js" type="text/javascript"></script>
  <script src="../js/tool.js" type="text/javascript"></script>
  <script src="../js/underscore.js" type="text/javascript"></script>
  <script>
  function Paper(domId) {
    this.paperEl = $("#"+domId);
    this.el = $('<div class="blocks"></div>');
    this.paperEl.append(this.el);
    this.blockId = 0;
    this.blocks = [];
    this.selectBox = new SelectBox(this);
    this.selectedBlock = null;
  }
  
  Paper.prototype.getBlockId = function() {
    return "b"+this.blockId++;
  };
  
  Paper.prototype.render = function() {
    $(".block").remove();
    
    for( var i=0; i<this.blocks.length; i++ ) {
      var block = this.blocks[i];
      block.render();
    }
  };
  
  Paper.prototype.addBlock = function() {
    var block = new Block(this);
    this.blocks.push(block);
  };
  
  Paper.prototype.addTitleBar = function(title) {
    var titleBar = new TitleBar(this, title);
    this.blocks.push(titleBar);
    return titleBar;
  };
  
  Paper.prototype.addParagraph = function(text) {
    var paragraph = new Paragraph(this, text);
    this.blocks.push(paragraph);
    return paragraph;
  };
  
  function SelectBox(paper) {
    this.paper = paper;
    this.target = null;
    this.el = $('<div class="select-box"></div>');
    this.el.draggable({ axis: "y", revert: "invalid"});
    this.paper.paperEl.append(this.el);
    
  }
  
  function Block(paper) {
    this.paper = paper;
    this.id = this.paper.getBlockId();
  }
  
  Block.prototype.render = function() {
    this.el = $('<div id="'+this.id+'" />');
    this.el.addClass("block");
    this.paper.el.append(this.el);
    
    //content element
    this.contentEl = $('<div class="content"></div>');
    this.el.append(this.contentEl);
    
    //
    var _this = this;
    this.dropEl = $('<div class="dropline"></div>');
    this.dropEl.droppable({ 
      accept: ".select-box", 
      activeClass: "highlight", 
      hoverClass: "hover", 
      tolerance: "intersect",
      drop: function( event, ui ) {
        var draggable = _this.paper.selectBox.target;
        var oldIndex = _.indexOf(_this.paper.blocks, draggable);
        var indexOfThis = _.indexOf(_this.paper.blocks, _this);
        if( oldIndex<=indexOfThis) {
          var newIndex = indexOfThis;
        } else {
          var newIndex = indexOfThis + 1;
        }
        
        _this.paper.blocks = move(_this.paper.blocks, oldIndex, newIndex);
        _this.paper.render();
        
        draggable.select();
      }
    });
    this.el.append(this.dropEl);
    
    this.el.click(function(e){
      _this.select();
    });
  };
  
  Block.prototype.select = function() {
    var top = this.el.position().top;
    var height = this.el.outerHeight();
    this.paper.selectBox.target = this;
    this.paper.selectedBlock = this;
    this.paper.selectBox.el.css({
      "top": top+"px",
      "height": height+"px",
      "display": "block"
    });
    
  }
  
  function TitleBar(paper, title) {
     Block.apply(this, arguments);
     this.height = 50;
     this.title = title;
  }
  
  extend(TitleBar, Block);
  
  TitleBar.prototype.render = function() {
    Block.prototype.render.call(this, arguments);
    this.el.addClass("titlebar");
    this.el.css("height", this.height+"px");
    
    this.titleEl = $('<span class="title">'+this.title+'</span>');
    this.contentEl.append(this.titleEl);
  };
  
  function Paragraph(paper, text) {
    Block.apply(this, arguments);
    this.text = text;
  }
  
  extend(Paragraph, Block);
  
  Paragraph.prototype.render = function() {
    Block.prototype.render.call(this, arguments);
    this.el.addClass("paragraph");
    
    this.textEl = $('<p>&nbsp;&nbsp;&nbsp;&nbsp;'+this.text+'</p>');
    this.contentEl.append(this.textEl);
  };
  
  $(document).ready(function(){
    var paper = new Paper("paper");
    
    var tb0 = paper.addTitleBar("日本同意搁置争议");
    paper.addParagraph("日本首相安倍晋三近日在接受美国《外交》杂志专访就钓鱼岛(日称“尖阁诸岛”)议题指出，日本从未同意“搁置钓鱼岛议题”的说法。");
    paper.addParagraph("中国大陆驻美大使崔天凯也在《外交》杂志指出，中方在美国于1972年将钓鱼岛连同冲绳移交给日本时即明确宣示反对，中方对钓鱼岛主权立场毫无疑问始终如一。崔天凯表示，中方了解这项争议需要时间解决，不急一夜间间找出方案。");
    paper.addParagraph("中国外交部发言人华春莹曾表示，<a href=#>钓鱼岛</a>问题涉及中国领土主权，中国坚决维护国家核心利益。");
    paper.render();
    
    
    
    // tb0.level = 2;
    // paper.render();
  });
  
  </script>
</head>
<body>
  <div id="paper">
    
  </div>
</body>
</html>